/*! Mosaico Cropper - v0.9.0 - 2019-03-12
* Copyright (c) 2019 ; MIT license */

!function(_){_.widget("mosaico.mosaicoCropper",{options:{autoClose:!0,shiftWheel:!1},_init:function(){void 0!==this.options.instance&&this.options.instance.dispose(!0),this.options.instance=function(n,s,a){function d(i){return{width:Math.round(Y.width*(i||U.scale)),height:Math.round(Y.height*(i||U.scale))}}function l(){return void 0!==s.maxScale?s.maxScale:2}var e,c=!1,h=!1;function p(i){c&&clearTimeout(c),h||(O.addClass("cropper-moving"),O.addClass("cropper-moving-"+i),h=i)}function u(){c&&clearTimeout(c),h&&(O.removeClass("cropper-moving"),O.removeClass("cropper-moving-"+h),h=!1)}function g(i,e,t){return i<e?e:t<i?t:i}function f(i,e){U.crop.height=parseInt(i),void 0!==e&&(U.crop.width=parseInt(e),O.css({width:U.crop.width+"px"})),T.css({height:U.crop.height+"px",width:U.crop.width+"px"});var t=s.width/Y.width,o=U.crop.height/Y.height,r=Math.max(t,o);r!==U.minScale&&(U.minScale=r,k.slider({min:z(r)}))}function v(i,e,t,o,r){var n=!1;void 0!==t&&(n=function(i){{if(U.scale===i)return!1;U.scale=i;var e=d(),t={width:e.width+"px",height:e.height+"px"};return W.css(t),P.css(t),!0}}(t));var a=d();if(void 0!==i&&(i=g(i,U.crop.width-a.width,0),U.container.left!==i&&(U.container.left=i,n=!0)),void 0!==e&&(e=g(e,U.crop.height-a.height,0),U.container.top!==e&&(U.container.top=e,n=!0)),n){var c={left:U.container.left+"px",top:U.container.top+"px"};(void 0===o||o)&&P.css(c),W.css(c),t&&!1!==r&&k.slider("value",z(t))}return n}function m(){var i,e,t,o=d(i=U.minScale);return e=Math.round((U.crop.width-o.width)/2),t=Math.round((U.crop.height-o.height)/2),v(e,t,i)}function w(i,e,t,o){var r=d();if(null==e&&(e=(U.crop.width/2-U.container.left)/r.width),null==t&&(t=(U.crop.height/2-U.container.top)/r.height),(i=g(i,U.minScale,l()))===U.scale)return!1;var n=d(i),a=Math.round((n.width-r.width)*e),c=Math.round((n.height-r.height)*t),s=U.container.left-a,h=U.container.top-c;return v(s,h,i,void 0,o),!0}function C(i,e,t,o,r){if(!s.autoZoom&&r<e&&(e=r),f(e=Math.round(e)),"original"==i||"cover"==i||"resize"==i)m();else if(r<e){var n=e/Y.height;w(n)}else{var a=Math.round((e-t)/2)+o;0<a&&(a=0),v(void 0,a)}}function M(i){var e=U.crop.height;return C(S().method,i,e,U.container.top,d().height),e!==U.crop.height}function x(){var i,e,t=m();t||(i=s.width/Y.width,e=M(Math.round(Y.height*i)),(t=e=w(i)||e)||w(1)),y()}function z(i){return Math.log(100*i)/Math.log(1.03)}function y(){var i=S();e!==i.method&&(O.removeClass("cropper-method-"+e),e=i.method,O.addClass("cropper-method-"+e)),O.addClass("cropper-has-changes")}function S(){var i=d(),e=-U.container.left,t=i.width-U.crop.width+U.container.left,o=-U.container.top,r=i.height-U.crop.height+U.container.top,n={resizeWidth:i.width,resizeHeight:i.height,offsetX:Math.max(0,-U.container.left),offsetY:Math.max(0,-U.container.top),cropX:Math.max(0,Math.round(e/U.scale)),cropY:Math.max(0,Math.round(o/U.scale)),cropWidth:Math.round(U.crop.width/U.scale),cropHeight:Math.round(U.crop.height/U.scale),width:U.crop.width,height:U.crop.height};n.cropX2=n.cropX+n.cropWidth,n.cropY2=n.cropY+n.cropHeight;var a=Math.abs(e-t),c=Math.abs(o-r);return n.method=void 0!==s.cropX?"cropresize":"resizecrop",a<=1&&c<=1&&(0===e||0===o)&&(n.method=0===e&&0===o?1!==U.scale?"resize":"original":"cover"),n}function o(){var i=S();i.urlPrefix=s.urlPrefix,i.urlPostfix=s.urlPostfix,i.urlOriginal=s.urlOriginal,i.cropThenResize=void 0!==s.cropX,i.encodedUrlOriginal=encodeURIComponent(s.urlOriginal);var e=s.urlAdapter.toSrc;return"object"==typeof e&&(e=!i.cropThenResize&&e.resizeThenCrop?e.resizeThenCrop:e.default),"string"==typeof e&&(e=function(i,r){return i.replace(/\{([^[\}]+)\}/g,function(i,e,t,o){return r.hasOwnProperty(e)?void 0!==r[e]?r[e]:"":i})}.bind(void 0,e)),e(i)}function X(){var t,e,i;I||(I=!0,t=r,e=function(){I=!1},i=o(),O.addClass("cropper-loading"),b(i,function(i,e){_(n).attr("src",e),O.removeClass("cropper-loading"),t()},function(i){O.removeClass("cropper-loading"),O.addClass("cropper-has-changes"),e()}),O.removeClass("cropper-has-changes"),s.imgLoadingClass&&_(n).removeClass(s.imgLoadingClass))}function r(i){if(!A){A=!0,L&&L.removeClass("cropper-cropping");try{T.resizable("destroy"),P.draggable("destroy"),k.slider("destroy")}catch(i){}O.remove(),s.imgLoadingClass&&_(n).removeClass(s.imgLoadingClass),_(n).css("display",R),i||void 0===a||a.destroy()}}function b(e,i,t){var o=new Image;o.onload=function(){i(o,e)},o.onerror=function(i){console.log("TODO img preload failed",i),t&&t(e)},o.src=e}var H={encodedUrlOriginal:"[^ &\\?]+",width:"[0-9]+",height:"[0-9]+",resizeWidth:"[0-9]+",resizeHeight:"[0-9]+",offsetX:"[0-9]+",offsetY:"[0-9]+",cropWidth:"[0-9]+",cropHeight:"[0-9]+",cropX:"[0-9]+",cropY:"[0-9]+",cropX2:"[0-9]+",cropY2:"[0-9]+"};var O=_('<div class="mo-cropper cropper-hidden" tabindex="-1"><div class="cropper-frame"><div class="clipping-container"><div class="toolbar"><div class="tool tool-zoom"><i class="fa fa-compress" aria-hidden="true"></i></div><div class="copper-zoom-slider"></div><div class="tool tool-crop"><i class="fa fa-check" aria-hidden="true"></i></div></div><img draggable="false" class="clipped clipped-image original-src"></div><div class="clip-handle ui-resizable-s"></div></div><div class="outer-image-container"><img class="outer-image original-src"></div></div>');_(n).after(O),s.imgLoadingClass&&_(n).addClass(s.imgLoadingClass);var i=s.urlAdapter.fromSrc;"string"==typeof i&&(i=function(i,e){var a=[],t=new RegExp("^"+i.replace(/\\.|(\((?!\?[!:=]))|\{([^:\}]+)(?::([^\}]+))?\}/g,function(t,i,e,o,r,n){if(i)return a.push(""),t;if(e){if(a.push(e),o)return o.replace(/\\.|(\((?!\?[!:=]))/g,function(i,e){return e&&a.push(""),t}),"("+o+")";if(H[e])return"("+H[e]+")";throw"Uknown token "+e+", please use {"+e+":regex} or use a known pattern"}return t})+"$"),o=e.match(t),r=null;if(null!==o){o.length!==a.length+1&&console.log("ERROR parsing pattern!",i,a,o),r={};for(var n=0;n<a.length;n++)""!==a[n]&&void 0!==o[n+1]&&(r[a[n]]=o[n+1])}return r}.bind(void 0,i));var t=i(n.src);t?t.encodedUrlOriginal&&(t.urlOriginal=decodeURIComponent(t.encodedUrlOriginal)):void 0!==s.urlAdapter.defaultPrefix?(s.urlOriginal=n.src,s.urlPrefix=s.urlAdapter.defaultPrefix,s.urlPostfix=n.src):console.error("FAILED PARSING",n.src);_.extend(s,t),s.width||(s.width=n.width,s.height=n.height);var Y,W=O.find(".clipped"),T=O.find(".cropper-frame"),P=O.find(".outer-image-container"),k=O.find(".copper-zoom-slider"),R=_(n).css("display"),A=!1,I=!1,L=!1;void 0!==s.containerSelector&&(L=_(s.containerSelector));var U={container:{},crop:{}},E=s.urlOriginal||(s.urlPrefix||"")+(s.urlPostfix||"");E.match(/[a-z]+:/)||(E="http://"+E);return b(E,function(i,e){var t,o,r;O.find(".original-src").attr("src",e),Y={width:i.naturalWidth,height:i.naturalHeight},L&&L.addClass("cropper-cropping"),!1!==s.autoClose&&O.focusout(function(i){null!=i.relatedTarget&&O.get(0).contains(i.relatedTarget)||void 0!==i.delegatedTarget||A||X()}),O.find(".tool-crop").on("click",function(){X()}),O.find(".tool-zoom").on("click",function(){x()}),O.focus(),function(){var i,e,t,o,r;if(void 0!==s.resizeWidth)o=s.resizeWidth/Y.width,i=s.height,r=s.width,e=-s.offsetX,t=-s.offsetY;else if(void 0!==s.cropX2||void 0!==s.cropWidth)null==s.cropWidth&&(s.cropWidth=s.cropX2-s.cropX),null==s.cropHeight&&(s.cropHeight=s.cropY2-s.cropY),null==s.cropX&&(s.cropX=0),null==s.cropY&&(s.cropY=0),o=s.width/s.cropWidth,i=s.height||s.cropHeight*o,r=s.width,e=Math.round(-s.cropX*o),t=Math.round(-s.cropY*o);else{o=s.width/Y.width,i=s.height||Math.round(Y.height*o),r=s.width;var n=d(o);e=Math.round((r-n.width)/2),t=Math.round((i-n.height)/2)}f(i,r),v(e,t,o)}(),T.resizable({minHeight:40,handles:{s:".clip-handle"},start:function(i,e){O.focus(),p("handle"),t=U.container.top,r=S().method,o=d().height},stop:function(i,e){u(),y()},resize:function(i,e){C(r,e.size.height,e.originalSize.height,t,o),y(),e.size.height=U.crop.height,void 0!==a&&a._trigger("cropheight",null,{value:U.crop.height})}}),T.find(".clip-handle").on("dblclick",function(i){return M(d().height),!1}),P.draggable({scroll:!1,start:function(i,e){O.focus(),p("drag")},stop:function(i,e){y(),u()},drag:function(i,e){v(Math.round(e.position.left),Math.round(e.position.top),void 0,!1),e.position.left=U.container.left,e.position.top=U.container.top,y()}}).on("wheel",function(i){if(s.shiftWheel&&!i.shiftKey)return!0;var e=-i.originalEvent.deltaY;if(O.focus(),0!==e){p("wheel"),c=setTimeout(u,500);var t=d(),o=i.originalEvent.offsetX/t.width,r=i.originalEvent.offsetY/t.height,n=0<e?1.1*U.scale:U.scale/1.1;w(n,o,r),y()}return!1}).on("dblclick",function(i){return x(),!1}).on("click",function(i){var e;O.focus(),e="click",h?u():p(e)}),k.slider({min:Math.floor(z(U.minScale)),step:1,value:Math.round(z(U.scale)),max:Math.ceil(z(l())),slide:function(i,e){var t,o=(t=e.value,Math.pow(1.03,t)/100);w(o,void 0,void 0,!1),y(),e.value=z(U.scale)},start:function(){p("slide")},stop:function(){u()}}),_(n).css("display","none"),O.css("display","inline"==R?"inline-block":R),O.removeClass("cropper-hidden"),O.focus(),void 0!==a&&a._trigger("copperready")},function(i){console.error("TODO Autodispose?"),setTimeout(r)}),{getScale:function(){return U.scale},updateScale:w,getCropHeight:function(){return U.crop.Height},updateCropHeight:M,dispose:r}}(this.element.get(0),this.options,this)},scale:function(i){if(void 0===i)return this.options.instance.getScale();this.options.instance.updateScale(i)},cropHeight:function(i){if(void 0===i)return this.options.instance.getCropHeight();this.options.instance.updateCropHeight(i)},_destroy:function(){this.options.instance.dispose(!0)}})}(jQuery);
//# sourceMappingURL=jqueryui-mosaico-cropper.min.js.map